<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rotas V2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <style>
        /* --- VARIAVEIS E RESET (BLACK GLASS) --- */
        :root {
            --primary: #EE4D2D; 
            --bg-body: #050505;
            --bg-glass: rgba(20, 20, 20, 0.65);
            --border-glass: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --success: #00e096;
            --warning: #f59e0b;
            --color-blue: #60A5FA;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        
        body {
            min-height: 100vh;
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(238, 77, 45, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(60, 100, 255, 0.05), transparent 25%);
            color: var(--text-main);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- LAYOUT --- */
        .main-wrapper { 
            width: 100%; 
            max-width: 1600px; 
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1;
        }

        .dashboard-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
            border-bottom: 1px solid var(--border-glass);
            padding-bottom: 1.5rem;
        }
        .dashboard-header h1 { font-size: 2rem; font-weight: 700; color: #fff; }

        .header-logo { height: 40px; filter: invert(1); opacity: 0.8; }

        /* Seletor de Hub */
        .hub-selector-container { 
            display: flex; align-items: center; gap: 10px; 
            background: rgba(255,255,255,0.05); padding: 8px 15px; 
            border-radius: 8px; border: 1px solid var(--border-glass); 
        }
        .hub-select { background: transparent; color: white; border: none; font-size: 1rem; outline: none; cursor: pointer; }
        .hub-select option { background: #111; color: white; }

        /* Navegação */
        .main-nav { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; }
        .nav-btn { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-glass);
            color: var(--text-muted); padding: 0.6rem 2rem; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s; font-weight: 600; letter-spacing: 0.5px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(238, 77, 45, 0.3); }

        /* Filtros */
        #filter-wrapper { padding: 1.5rem; background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: 1rem; margin-bottom: 2rem; }
        #filter-controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .filter-group { flex-grow: 1; min-width: 200px; }
        .filter-input { 
            background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem; color: white; padding: 0.8rem 1rem; width: 100%;
        }
        .filter-input:focus { border-color: var(--primary); outline: none; }

        /* Cards KPI */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { 
            background: var(--bg-glass); border: 1px solid var(--border-glass); 
            border-radius: 1rem; padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; 
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.2); }
        .kpi-card .icon { 
            font-size: 2rem; background: rgba(255, 255, 255, 0.05); 
            border-radius: 12px; width: 60px; height: 60px; 
            display: flex; align-items: center; justify-content: center; 
        }
        .kpi-card .content h3 { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .kpi-card .content p { font-size: 1.8rem; font-weight: 700; color: #fff; }

        /* Gráficos */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; }
        .chart-container { 
            height: 400px; background: var(--bg-glass); 
            border: 1px solid var(--border-glass); border-radius: 1rem; 
            padding: 1rem; position: relative;
        }

        /* Tabela */
        #table-container { 
            width: 100%; max-height: 60vh; overflow: auto; 
            background: var(--bg-glass); border: 1px solid var(--border-glass); 
            border-radius: 1rem; 
        }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; background: #151515; z-index: 5; }
        th { padding: 1rem; text-align: left; color: var(--primary); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border-glass); }
        td { padding: 1rem; border-bottom: 1px solid var(--border-glass); color: #ddd; font-size: 0.9rem; }
        tr:hover { background: rgba(255,255,255,0.03); }

        .footer-credits {
            margin-top: auto; padding: 2rem; text-align: center;
            border-top: 1px solid var(--border-glass); color: var(--text-muted);
        }
        .footer-credits span { color: var(--text-main); font-weight: 600; display: block; margin-top: 5px; }

        .view-container { display: none; animation: fadeIn 0.3s ease; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #pagination-controls { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { background: var(--primary); border: none; padding: 8px 16px; border-radius: 4px; color: white; cursor: pointer; }
        .page-btn:disabled { background: #333; cursor: not-allowed; }
        #status-bar { text-align: center; color: #666; margin: 10px 0; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="color:#888;">Carregando dados...</p>
    </div>

    <div class="main-wrapper">
        <div class="dashboard-header">
            <div style="display:flex; align-items:center; gap: 15px;">
                <img src="https://logodownload.org/wp-content/uploads/2019/08/shopee-logo-1.png" alt="Logo" class="header-logo">
                <h1>Dashboard de Rotas V2</h1>
            </div>
            
            <div class="hub-selector-container">
                <i class="fas fa-map-marker-alt" style="color: var(--primary);"></i>
                <select id="hub-select" class="hub-select" onchange="loadHubData()">
                    <option value="" disabled>Selecione o Hub</option>
                </select>
            </div>
        </div>

        <nav class="main-nav">
            <button id="nav-tabela" class="nav-btn active">Tabela Detalhada</button>
            <button id="nav-graficos" class="nav-btn">Gráficos & Insights</button>
        </nav>

        <div id="filter-wrapper">
            <div id="filter-controls">
                <div class="filter-group"><input type="text" id="filter-nome-id" class="filter-input" placeholder="Buscar Motorista ou ID..."></div>
                <div class="filter-group"><input type="text" id="filter-at" class="filter-input" placeholder="Buscar AT..."></div>
                <div class="filter-group"><input type="text" id="filter-local" class="filter-input" placeholder="Cidade ou Bairro..."></div>
                <div class="filter-group"><input type="date" id="filter-data-inicio" class="filter-input"></div>
                <div class="filter-group"><input type="date" id="filter-data-fim" class="filter-input"></div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><div class="icon"><i class="fas fa-route" style="color:var(--primary)"></i></div><div><h3>Total Rotas</h3><p id="kpi-rotas">0</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-box" style="color:var(--success)"></i></div><div><h3>Pacotes</h3><p id="kpi-pacotes">0</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-users" style="color:var(--color-blue)"></i></div><div><h3>Motoristas</h3><p id="kpi-drivers">0</p></div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-map" style="color:var(--warning)"></i></div><div><h3>Cidades</h3><p id="kpi-cidades">0</p></div></div>
        </div>

        <div id="table-view" class="view-container active">
            <div id="status-bar"></div>
            <div id="table-container"></div>
            <div id="pagination-controls"></div>
        </div>

        <div id="charts-view" class="view-container">
            <div class="charts-grid">
                <div class="chart-container" id="chart-rotas-driver"></div>
                <div class="chart-container" id="chart-pacotes-driver"></div>
                <div class="chart-container" id="chart-pacotes-status"></div>
                
                <div class="chart-container" id="chart-rotas-por-data"></div>
                <div class="chart-container" id="chart-pacotes-por-data"></div>
                
                <div class="chart-container" id="chart-drivers-cidade"></div>
                <div class="chart-container" id="chart-drivers-bairro"></div>
                <div class="chart-container" id="chart-pacotes-cidade"></div>
                <div class="chart-container" id="chart-pacotes-bairro"></div>
                
                <div class="chart-container" id="chart-drivers-ran-month"></div>
            </div>
        </div>
    </div>

    <footer class="footer-credits">
         <p>Desenvolvido por</p>
        <span>Yuri Barbosa LBA-01 & Eliane Santos</span>
    </footer>

    <script>
        // --- CONFIGURAÇÃO GLOBAL ---
        let allData = [], currentFilteredData = [], headers = [], colIdx = {}, page = 1;
        const ROWS_PAGE = 100;
        let chartInstances = {};

        // Mapeamento de Colunas (AJUSTE AQUI SE O NOME NO SHEETS MUDAR)
        const COLS = {
            DRIVER: 'Driver_Nome',
            ID: 'Driver_ID',
            AT: 'AT_ID',
            CIDADE: 'Cidade',
            BAIRRO: 'Bairro',
            DATA: 'Data_Atribuicao',
            PACOTES: 'Pacotes_API',
            STATUS: 'Status'
        };

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            // Eventos
            document.getElementById('nav-tabela').onclick = () => switchView('tabela');
            document.getElementById('nav-graficos').onclick = () => switchView('graficos');
            document.querySelectorAll('.filter-input').forEach(i => i.oninput = debounce(applyFilters, 400));
            
            // Carrega Hubs
            google.script.run.withSuccessHandler(hubs => {
                const sel = document.getElementById('hub-select');
                
                // ADICIONADO: Opção Consolidado como primeiro item
                let optAll = document.createElement('option');
                optAll.value = 'CONSOLIDADO';
                optAll.text = '★ VISÃO CONSOLIDADA (TODOS)';
                optAll.style.fontWeight = 'bold';
                optAll.style.color = '#EE4D2D'; // Laranja destaque
                sel.add(optAll);

                hubs.forEach(h => {
                    let opt = document.createElement('option');
                    opt.value = h; opt.text = h;
                    sel.add(opt);
                });
                
                // Carrega o consolidado ou o primeiro hub por padrão
                sel.value = 'CONSOLIDADO';
                loadHubData(); 

            }).getHubNames();
        };

        function switchView(v) {
            document.querySelectorAll('.view-container').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-'+v).classList.add('active');
            if(v === 'tabela') document.getElementById('table-view').classList.add('active');
            if(v === 'graficos') {
                document.getElementById('charts-view').classList.add('active');
                lazyLoadCharts(); 
            }
        }

        // --- CARREGAMENTO DE DADOS COM LÓGICA DE CONSOLIDADO ---
        function loadHubData() {
            const hub = document.getElementById('hub-select').value;
            if(!hub) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // Callback de sucesso comum
            const onSuccess = (res) => {
                if(!res || !res.rows || !res.rows.length) { 
                    alert('Nenhum dado encontrado.'); 
                    document.getElementById('loading-overlay').style.display = 'none';
                    return; 
                }
                
                headers = res.headers;
                colIdx = {};
                headers.forEach((h, i) => colIdx[h.trim()] = i);
                
                allData = res.rows;
                currentFilteredData = allData;
                
                page = 1;
                renderTable();
                updateKPIs();
                
                if(document.getElementById('charts-view').classList.contains('active')) lazyLoadCharts();
                
                document.getElementById('loading-overlay').style.display = 'none';
            };

            // Lógica para decidir qual função chamar no backend
            if(hub === 'CONSOLIDADO') {
                google.script.run.withSuccessHandler(onSuccess).fetchDadosConsolidados();
            } else {
                google.script.run.withSuccessHandler(onSuccess).fetchDadosHub(hub);
            }
        }

        // --- FILTROS ---
        function applyFilters() {
            const termo = document.getElementById('filter-nome-id').value.toLowerCase();
            const at = document.getElementById('filter-at').value.toLowerCase();
            const local = document.getElementById('filter-local').value.toLowerCase();
            const dIni = document.getElementById('filter-data-inicio').value;
            const dFim = document.getElementById('filter-data-fim').value;

            const dtStart = dIni ? new Date(dIni + 'T00:00:00') : null;
            const dtEnd = dFim ? new Date(dFim + 'T23:59:59') : null;

            currentFilteredData = allData.filter(row => {
                const driver = (row[colIdx[COLS.DRIVER]] || '').toLowerCase();
                const id = (row[colIdx[COLS.ID]] || '').toLowerCase();
                const atVal = (row[colIdx[COLS.AT]] || '').toLowerCase();
                const cid = (row[colIdx[COLS.CIDADE]] || '').toLowerCase();
                const bai = (row[colIdx[COLS.BAIRRO]] || '').toLowerCase();
                
                if(termo && !driver.includes(termo) && !id.includes(termo)) return false;
                if(at && !atVal.includes(at)) return false;
                if(local && !cid.includes(local) && !bai.includes(local)) return false;

                if(dtStart || dtEnd) {
                    const dtStr = row[colIdx[COLS.DATA]]; 
                    if(!dtStr || dtStr === 'N/A') return false;
                    const parts = dtStr.split(' ')[0].split('/'); 
                    if(parts.length === 3) {
                        const rowDt = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T12:00:00`);
                        if(dtStart && rowDt < dtStart) return false;
                        if(dtEnd && rowDt > dtEnd) return false;
                    }
                }
                return true;
            });

            page = 1;
            renderTable();
            updateKPIs();
            if(document.getElementById('charts-view').classList.contains('active')) lazyLoadCharts();
        }

        // --- TABELA & KPIs ---
        function renderTable() {
            const div = document.getElementById('table-container');
            const start = (page-1)*ROWS_PAGE;
            const data = currentFilteredData.slice(start, start+ROWS_PAGE);
            
            document.getElementById('status-bar').innerText = `Exibindo ${data.length} de ${currentFilteredData.length} registros`;

            let h = '<table><thead><tr>';
            headers.forEach(head => h+=`<th>${head}</th>`);
            h+='</tr></thead><tbody>';
            
            data.forEach(r => {
                h+='<tr>';
                r.forEach((c, i) => {
                    let style = '';
                    if(headers[i] === COLS.STATUS) {
                        if(c === 'Atribuído') style='color:var(--warning)';
                        if(c === 'Concluído') style='color:var(--success)';
                    }
                    h+=`<td style="${style}">${c||''}</td>`;
                });
                h+='</tr>';
            });
            h+='</tbody></table>';
            div.innerHTML = h;
            renderPag();
        }

        function renderPag() {
            const total = Math.ceil(currentFilteredData.length / ROWS_PAGE);
            const div = document.getElementById('pagination-controls');
            if(total <= 1) { div.innerHTML = ''; return; }
            div.innerHTML = `
                <button class="page-btn" onclick="mudarPag(-1)" ${page===1?'disabled':''}>Ant</button>
                <span style="color:white; align-self:center">Pág ${page}/${total}</span>
                <button class="page-btn" onclick="mudarPag(1)" ${page===total?'disabled':''}>Prox</button>
            `;
        }
        window.mudarPag = (d) => { page += d; renderTable(); }

        function updateKPIs() {
            const data = currentFilteredData;
            document.getElementById('kpi-rotas').innerText = data.length.toLocaleString();
            
            let pacotes = 0, drivers = new Set(), cidades = new Set();
            const idxPac = colIdx[COLS.PACOTES];
            const idxDrv = colIdx[COLS.DRIVER];
            const idxCid = colIdx[COLS.CIDADE];

            data.forEach(r => {
                pacotes += (parseInt(r[idxPac]) || 0);
                if(r[idxDrv]) drivers.add(r[idxDrv]);
                if(r[idxCid]) cidades.add(r[idxCid]);
            });

            document.getElementById('kpi-pacotes').innerText = pacotes.toLocaleString();
            document.getElementById('kpi-drivers').innerText = drivers.size.toLocaleString();
            document.getElementById('kpi-cidades').innerText = cidades.size.toLocaleString();
        }

        // --- GRÁFICOS INTELIGENTES ---
        function lazyLoadCharts() {
            Object.values(chartInstances).forEach(c => c.dispose());
            chartInstances = {};

            const configs = [
                { id:'chart-rotas-driver', type:'bar', title:'Top Rotas por Motorista', key: COLS.DRIVER, op:'count', limit:15, color:'#EE4D2D' },
                { id:'chart-pacotes-driver', type:'bar', title:'Top Pacotes por Motorista', key: COLS.DRIVER, op:'sum', val: COLS.PACOTES, limit:15, color:'#60A5FA' },
                
                { id:'chart-pacotes-status', type:'pie', title:'Status Pacotes', key: COLS.STATUS, op:'sum', val: COLS.PACOTES },

                { id:'chart-rotas-por-data', type:'line', title:'Evolução Rotas (Dia)', key: COLS.DATA, op:'count', isDate:true, color:'#0EA5E9' },
                { id:'chart-pacotes-por-data', type:'line', title:'Evolução Pacotes (Dia)', key: COLS.DATA, op:'sum', val: COLS.PACOTES, isDate:true, color:'#10B981' },

                { id:'chart-drivers-cidade', type:'bar', title:'Motoristas por Cidade', key: COLS.CIDADE, op:'unique', uniq: COLS.DRIVER, color:'#F59E0B' },
                { id:'chart-drivers-bairro', type:'bar', title:'Motoristas por Bairro', key: COLS.BAIRRO, op:'unique', uniq: COLS.DRIVER, color:'#8B5CF6' },
                { id:'chart-pacotes-cidade', type:'bar', title:'Pacotes por Cidade', key: COLS.CIDADE, op:'sum', val: COLS.PACOTES, color:'#EC4899' },
                { id:'chart-pacotes-bairro', type:'bar', title:'Pacotes por Bairro', key: COLS.BAIRRO, op:'sum', val: COLS.PACOTES, color:'#6366F1' },

                // REMOVIDO DA CONFIGURAÇÃO: chart-drivers-started-month
                { id:'chart-drivers-ran-month', type:'bar', title:'Motoristas Ativos (Mês)', special:'ran', color:'#10B981' }
            ];

            configs.forEach((cfg, i) => {
                setTimeout(() => processAndRenderChart(cfg), i * 50);
            });
        }

        function processAndRenderChart(cfg) {
            const dom = document.getElementById(cfg.id);
            if(!dom) return;
            
            let dataPoints = [];

            if(cfg.special) {
                dataPoints = processMonthlyData(cfg.special);
            } 
            else {
                const map = {};
                const idxKey = colIdx[cfg.key];
                const idxVal = cfg.val ? colIdx[cfg.val] : null;
                const idxUniq = cfg.uniq ? colIdx[cfg.uniq] : null;

                currentFilteredData.forEach(r => {
                    let k = r[idxKey];
                    if(!k || k === 'N/A') return;
                    
                    if(cfg.isDate) {
                        const p = k.split(' ')[0].split('/');
                        if(p.length===3) k = `${p[2]}-${p[1]}-${p[0]}`; 
                    }

                    if(cfg.op === 'count') map[k] = (map[k]||0) + 1;
                    else if(cfg.op === 'sum') map[k] = (map[k]||0) + (parseInt(r[idxVal])||0);
                    else if(cfg.op === 'unique') {
                        if(!map[k]) map[k] = new Set();
                        if(r[idxUniq]) map[k].add(r[idxUniq]);
                    }
                });

                dataPoints = Object.entries(map).map(([name, val]) => {
                    let v = val;
                    if(val instanceof Set) v = val.size;
                    return { name: name, value: v };
                });

                if(cfg.isDate) dataPoints.sort((a,b) => a.name.localeCompare(b.name)); 
                else dataPoints.sort((a,b) => b.value - a.value); 

                if(cfg.isDate) {
                    dataPoints.forEach(d => {
                        const p = d.name.split('-');
                        d.name = `${p[2]}/${p[1]}`;
                    });
                }
            }

            if(cfg.limit) dataPoints = dataPoints.slice(0, cfg.limit);

            const chart = echarts.init(dom, null, {renderer:'svg'});
            chartInstances[cfg.id] = chart;
            
            const options = {
                backgroundColor: 'transparent',
                title: { text: cfg.title, left: 'center', textStyle: { color: '#fff', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(0,0,0,0.8)', textStyle: {color:'#fff'} },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: cfg.type !== 'pie' ? { 
                    type: 'category', 
                    data: dataPoints.map(d => d.name),
                    axisLabel: { color: '#888', rotate: 30 }
                } : undefined,
                yAxis: cfg.type !== 'pie' ? { 
                    type: 'value', 
                    splitLine: { show: false },
                    axisLabel: { color: '#888' }
                } : undefined,
                series: [{
                    type: cfg.type,
                    data: cfg.type === 'pie' ? dataPoints : dataPoints.map(d => d.value),
                    itemStyle: { color: cfg.color },
                    radius: cfg.type === 'pie' ? ['40%', '70%'] : undefined
                }]
            };
            chart.setOption(options);
        }

        function processMonthlyData(mode) {
            const idxDate = colIdx[COLS.DATA];
            const idxDrv = colIdx[COLS.DRIVER];
            const map = {};

            if(mode === 'ran') {
                currentFilteredData.forEach(r => {
                    const dt = r[idxDate]; const drv = r[idxDrv];
                    if(!dt || !drv) return;
                    const parts = dt.split(' ')[0].split('/');
                    if(parts.length !== 3) return;
                    const key = `${parts[1]}/${parts[2]}`; 
                    
                    if(!map[key]) map[key] = new Set();
                    map[key].add(drv);
                });
                return Object.keys(map)
                    .sort((a,b) => {
                        const [m1,y1] = a.split('/'); const [m2,y2] = b.split('/');
                        return (y1+m1).localeCompare(y2+m2);
                    })
                    .slice(-12) 
                    .map(k => ({ name: k, value: map[k].size }));
            }
            // REMOVIDO BLOCO "started"
            return [];
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
